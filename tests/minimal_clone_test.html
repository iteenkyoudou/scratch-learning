<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最小限クローンテスト</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .stage { width: 400px; height: 200px; border: 2px solid #333; margin: 20px 0; position: relative; background: #f8f8f8; }
        .sprite { width: 40px; height: 40px; background: red; border-radius: 50%; position: absolute; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        .status { border: 1px solid #007bff; padding: 10px; margin: 10px 0; background: #f0f8ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 最小限クローンテスト</h1>
        
        <div class="stage" id="stage">
            <div class="sprite" id="sprite" style="left: 50px; top: 50px;">😸</div>
        </div>
        
        <div class="status" id="status">準備完了</div>
        
        <button class="btn" onclick="test1()">テスト1: 1個クローン</button>
        <button class="btn" onclick="test2()">テスト2: 3個クローン</button>
        <button class="btn" onclick="clearAll()">クリア</button>
    </div>

    <script>
        console.log('最小限テスト開始');

        function test1() {
            console.log('=== テスト1開始 ===');
            
            try {
                const sprite = document.getElementById('sprite');
                const stage = document.getElementById('stage');
                const status = document.getElementById('status');
                
                console.log('要素確認:', {sprite, stage, status});
                
                if (!sprite || !stage || !status) {
                    throw new Error('要素が見つかりません');
                }
                
                // 既存のクローンをクリア
                clearAll();
                
                // 1個のクローンを作成
                const clone = sprite.cloneNode(true);
                clone.id = 'test-clone-1';
                clone.style.left = '150px';
                clone.style.top = '100px';
                clone.style.background = 'blue';
                
                console.log('クローン作成:', clone);
                
                stage.appendChild(clone);
                
                console.log('クローン追加完了');
                
                status.textContent = '✅ 1個のクローンが作成されました';
                
                // クローンが実際に追加されたか確認
                const addedClone = document.getElementById('test-clone-1');
                console.log('追加確認:', addedClone);
                
                if (!addedClone) {
                    throw new Error('クローンが見つかりません');
                }
                
                console.log('=== テスト1成功 ===');
                
            } catch (error) {
                console.error('テスト1エラー:', error);
                document.getElementById('status').textContent = '❌ エラー: ' + error.message;
            }
        }

        function test2() {
            console.log('=== テスト2開始 ===');
            
            try {
                const sprite = document.getElementById('sprite');
                const stage = document.getElementById('stage');
                const status = document.getElementById('status');
                
                if (!sprite || !stage || !status) {
                    throw new Error('要素が見つかりません');
                }
                
                // 既存のクローンをクリア
                clearAll();
                
                // 3個のクローンを作成
                for (let i = 1; i <= 3; i++) {
                    console.log(`クローン${i}作成中`);
                    
                    const clone = sprite.cloneNode(true);
                    clone.id = `test-clone-${i}`;
                    clone.style.left = (50 + i * 80) + 'px';
                    clone.style.top = (50 + i * 20) + 'px';
                    clone.style.background = `hsl(${i * 120}, 70%, 60%)`;
                    
                    stage.appendChild(clone);
                    
                    console.log(`クローン${i}追加完了`);
                }
                
                status.textContent = '✅ 3個のクローンが作成されました';
                
                console.log('=== テスト2成功 ===');
                
            } catch (error) {
                console.error('テスト2エラー:', error);
                document.getElementById('status').textContent = '❌ エラー: ' + error.message;
            }
        }

        function clearAll() {
            console.log('=== クリア開始 ===');
            
            try {
                const clones = document.querySelectorAll('[id^="test-clone-"]');
                console.log('削除対象:', clones.length);
                
                clones.forEach((clone, index) => {
                    console.log(`クローン${index + 1}削除`);
                    clone.remove();
                });
                
                document.getElementById('status').textContent = 'クリア完了';
                
                console.log('=== クリア成功 ===');
                
            } catch (error) {
                console.error('クリアエラー:', error);
                document.getElementById('status').textContent = '❌ クリアエラー: ' + error.message;
            }
        }

        // グローバルエラーハンドラー
        window.addEventListener('error', function(event) {
            console.error('グローバルエラー:', event.error);
            const status = document.getElementById('status');
            if (status) {
                status.textContent = '❌ グローバルエラー: ' + event.error.message;
            }
            // 白画面を防ぐ
            event.preventDefault();
            return true;
        });

        window.addEventListener('load', function() {
            console.log('ページロード完了');
        });
    </script>
</body>
</html>